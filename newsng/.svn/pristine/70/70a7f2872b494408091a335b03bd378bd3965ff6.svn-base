<style>

    .toolbox ul li {
        float: left;
        margin-right: 4px;
        line-height: 30px;
        position: relative;
        list-style: none;
    }
    .toolbox ul li.title {
        font-size: 16px;
        padding: 0 10px;
    }

    /*打印听课凭证*/
    .print_toolbox {
        margin: 20px 0 0;
        position: relative;
        height: 180px;
        width:960px
    }

    .print_showbox {
        height: 560px;
        line-height: 36px;
        text-align: center;
        border: 1px #d4d4d4 solid;
        margin-bottom: 30px;
        background: #fff;
        font-size: 14px;
        /*padding-top: 160px;*/
        width: 960px;
        position: relative;
        overflow: hidden;
    }
    .printClosed {
        position: absolute;
        background: #FF5722;
        top: -12px;
        right: -12px;
        width: 24px;
        height: 24px;
        line-height: 21px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
    }
    .print_toolbox ul {
        background-color: #fafafa;
        background-image: -moz-linear-gradient(top, #f0f0f0, #f2f2f2);
        background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#f0f0f0),
        to(#f2f2f2));
        background-image: -webkit-linear-gradient(top, #f0f0f0, #f2f2f2);
        background-image: -o-linear-gradient(top, #f0f0f0, #f2f2f2);
        background-image: linear-gradient(to bottom, #f0f0f0, #f2f2f2);
        box-shadow: 0px 2px 5px #d3d6da;
        position: absolute;
        border: 1px #d4d4d4 solid;
        top: 0px;
        left: 0;
       /* max-height: 100%;*/
        border-radius: 2px;
        z-index: 1000;
        padding: 15px;
    }

    .print_toolbox ul li {
       /* width: 60px;
        height: 30px;
        display: inline-block;
        !* margin: 5px; *!
        line-height: 30px;
        text-align: center;
        color: #fff;
        margin-bottom: 10px;
        background: #1BBB99;
        border: 1px #14A888 solid;
        border-radius: 2px;*/
        margin-bottom: 5px;
        margin-left: 5px;
        cursor: move;
        width: 124px;

    }

    .printbtn-box {
        padding: 0 0 30px;
        text-align: center
    }

    .print_toolbox button { margin-bottom: 5px; margin-left: 5px; cursor: move}
</style>
<div style="padding: 40PX;">
    <form class="gui-form gui-form-label-right" id="add-form" >

        <div class="wrap" style="margin:0 auto;  ">
            <div class="gui-form-item"><label class="gui-form-item-label">凭证尺寸</label>
                <div class="gui-form-item-content">
                    <input type="text" name="width" placeholder="请输入宽度" class="gui-input" value="" data-onlyNumber="true"  maxlength="50" style="margin-right: 5px" id="paperWidth">*
                    <input type="text" name="height" placeholder="请输入高度" class="gui-input" value="" data-onlyNumber="true" maxlength="50"  id="paperHeight">（单位：mm）
                    <input type="hidden" name="temName"  class="gui-input" value="" maxlength="50"  id="voucher_model_id">
                   <!-- <input type="file" capture="camera" name="file"  id="upFile" class="webuploader-element-invisible" multiple="multiple" accept="image/jpg,image/jpeg,image/png" style="display:none">-->
                    <button type="button" class="gui-btn gui-btn-normal" id="upimg-btn"><i class="fa fa-save"></i><span>选择图片</span></button>
                </div>
            </div>

            <div class="print_box">
                <div class="print_toolbox">
                    <ul>
                       <!-- <li id="type_1" class="ui-draggable"  >凭证编号
                            <div class="printClosed">x</div>
                        </li>-->
                        <li id="type_1"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">主标题</li>
                        <li id="type_2"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">副标题</li>
                        <li id="type_3"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">学期</li>
                        <li id="type_4"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">学员姓名</li>
                        <li id="type_5"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">证件号</li>
                        <li id="type_6"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">教师姓名</li>
                        <li id="type_7"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">科目班级</li>
                        <li id="type_8"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">班级类型</li>
                        <li id="type_9"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">课时数</li>
                        <li id="type_10"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">开课日期</li>
                        <li id="type_11"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">上课时间</li>
                        <li id="type_12"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">学费标准</li>
                        <li id="type_13"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">校区</li>
                        <li id="type_14"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">教室</li>
                        <li id="type_15"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">班容量</li>
                        <li id="type_16"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">缴费方式</li>
                        <li id="type_17"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">缴费金额</li>
                        <li id="type_18"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">缴费金额大写</li>
                        <li id="type_19"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">缴费时间</li>
                        <li id="type_20"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">凭证编号</li>
                        <li id="type_21"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">凭证日期</li>
                        <li id="type_22"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">操作人</li>
                        <li id="type_23"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">自定义1</li>
                        <li id="type_24"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">自定义2</li>
                        <li id="type_25"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">自定义3</li>
                        <li id="type_26"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">自定义4</li>
                        <li id="type_27"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">自定义5</li>
                        <li id="type_28"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">自定义6</li>
                  <!--      <li id="type_29"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">自定义7</li>
                        <li id="type_30"  class="gui-btn gui-btn-normal ui-draggable" title="拖动加入打印项">自定义8</li>-->

                    </ul>
                </div>
                <div class="print_showbox ui-droppable ui-state-highlight" id="print_showbox">
                    <img id="ImgPr" style="position:absolute;top:-0px;left:-2px;max-width: unset;"   src="images/print.jpg">
                </div>

            </div>

            <div class="clear"></div>
            <div class="printbtn-box">
                <button type="button" class="gui-btn gui-btn gui-btn-normal" id="preview"><i class="fa fa-eye"></i>测试打印</button>
                <button type="button" class="gui-btn" id="updata-btn"><i class="fa fa-save"></i>保存</button>
            </div>
        </div>
    </form>


</div>
<script type="text/javascript" src="js/print//jqueryui-core-drag.js"></script>
<script type="text/javascript" src="js/print/LodopFuncs.js"></script>
<script type="text/javascript" src="js/print/uploadPreview.min.js"></script>
<script type="text/javascript" src="js/webupload/webuploader.js"></script>
<script>

    var localADDinfo={};

    var button = {
        "type_1": {
            "top": 15,
            "left": 15
        },
        "type_2": {
            "top": 15,
            "left": 148.140625
        },
        "type_3": {
            "top": 15,
            "left": 280.28125
        },
        "type_4": {
            "top": 15,
            "left": 412.421875
        },
        "type_5": {
            "top": 15,
            "left": 544.5625
        },
        "type_6": {
            "top": 15,
            "left": 676.703125
        },
        "type_7": {
            "top": 15,
            "left": 808.84375
        },
        "type_8": {
            "top": 52,
            "left": 15
        },
        "type_9": {
            "top": 52,
            "left": 147.140625
        },
        "type_10": {
            "top": 52,
            "left": 279.28125
        },
        "type_11": {
            "top": 52,
            "left": 411.421875
        },
        "type_12": {
            "top": 52,
            "left": 543.5625
        },
        "type_13": {
            "top": 52,
            "left": 675.703125
        },
        "type_14": {
            "top": 52,
            "left": 807.84375
        },
        "type_15": {
            "top": 89,
            "left": 15
        },
        "type_16": {
            "top": 89,
            "left": 147.140625
        },
        "type_17": {
            "top": 89,
            "left": 279.28125
        },
        "type_18": {
            "top": 89,
            "left": 411.421875
        },
        "type_19": {
            "top": 89,
            "left": 543.5625
        },
        "type_20": {
            "top": 89,
            "left": 675.703125
        },
        "type_21": {
            "top": 89,
            "left": 807.84375
        },
        "type_22": {
            "top": 126,
            "left": 15
        },
        "type_23": {
            "top": 126,
            "left": 147.140625
        },
        "type_24": {
            "top": 126,
            "left": 279.28125
        },
        "type_25": {
            "top": 126,
            "left": 411.421875
        },
        "type_26": {
            "top": 126,
            "left": 543.5625
        },
        "type_27": {
            "top": 126,
            "left": 675.703125
        },
        "type_28": {
            "top": 126,
            "left": 807.84375
        }
    };


    //图片存储
    var imgId = [];
    $(function() {

        //获取机构打印凭证信息
        var get={
            "parameter":{
                "org_id":option.org_id,
                "token":option.token,
                "udid":option.udid
            },
            "url":domain+"/voucher/model/info.htm"
        };

        getData(get.url,get.parameter,function (result) {

            if(result.code==200 && result.success==true){

                var toTata = result.data;

                if(toTata!==null){

                    $("#paperHeight").val(toTata.background_length);
                    $("#paperWidth").val(toTata.background_width);

                    if(toTata.img_url!==null && toTata.img_url!==""){
                        //图片地址
                        $("#upimg-btn").attr("data-img",changeImgUrl(toTata.img_url));
                        $("#ImgPr").attr("src",changeImgUrl(toTata.img_url));
                        imgId.push(toTata.img_url);
                    }


                    $("#voucher_model_id").val(toTata.voucher_model_id);

                    localADDinfo=eval('(' + toTata.voucher_content + ')');

                    for (var p in localADDinfo) {
                        var obj = localADDinfo[p];

                        if(obj.top!==""){
                            //通过文字获取id

                            $("#" + p).css({
                                "top": obj.top+124-button[p].top,
                                "left": obj.left-button[p].left+3,
                            });
                            $("#" + p).attr("data-save", "yes");
                            $("#" + p).append("<div class=\"printClosed\">x</div>");
                        }


                    }
                }


            }else {
                myAlert(result.message,2,result.code,null);
            }
        },"POST",false)



        //触发自动上传

        imgUpload($("#upimg-btn"));

       // resetPromptMessageCoordinate();
    });




</script>
<script type="text/javascript">
    //本地存储按钮的位置信息
    var toolPosition = {};
    var updata = [];

    $(function() {

        $(".print_toolbox ul li").off("click", "div");

        //拖动
        $(".print_toolbox ul li").draggable({
            revert: "invalid",
            containment: "#print_showbox",
            opacity: 0.35,
            stop: function(event, ui) {
                var top = $(this).position().top - 124,
                    left = $(this).position().left;
                //存入本地
                toolPosition[$(this)[0].id] = ({
                    top: top,
                    left: left,
                    content: $(this)[0].innerHTML
                });

                //清空数组里的信息
                updata.splice(0, updata.length);
                //按钮位置信息
                $(this).attr("data-save", "yes");
                if($(this).find("div").length == 0 && $(this).position().top > 57) {
                    $(this).append("<div class=\"printClosed\">x</div>");
                }
            }
        });

        /*删除*/
        $(".print_toolbox ul li").on("click", "div", function() {
            //还原位置
            $(this).parent().removeAttr("style").css("position", "relative");
            $(this).parent().removeAttr("data-save");
            //删除存储的位置信息
            var nowId = $(this).parent().attr("id");
            $(this).remove();
            delete toolPosition[nowId];
            delete localADDinfo[nowId]
        });

        $("#print_showbox").droppable({
            activeClass: "ui-state-hover",
            hoverClass: "ui-state-active",
            drop: function(event, ui) {
                $(this).addClass("ui-state-highlight").find("p").html("Dropped!");
            }
        });

        //保存
        $("#updata-btn").click(function() {
            var paperHeight = $.trim($("#paperHeight").val());
            var paperWidth = $.trim($("#paperWidth").val());

            //验证是否设置纸张高度、宽度
            if(paperHeight == "") {
                myAlert("纸张高度不能为空！",2,null,function(){
                    $("#paperHeight").focus();
                });
                return false;
            }

            if(Number(paperHeight) <= 0) {
                myAlert("纸张高度只能为正整数！",2,null,function(){
                    $("#paperHeight").focus();
                });
                return false;
            }

            if(paperWidth == "") {
                myAlert("纸张宽度不能为空！",2,null,function(){
                    $("#paperWidth").focus();
                });
                return false;
            }

            if(Number(paperWidth) <= 0) {
                myAlert("纸张宽度只能为正整数！",2,null,function(){
                    $("#paperWidth").focus();
                });
                return false;
            }

            //获取本地数据
            updata = {};

            $(".print_toolbox ul li[data-save]").each(function() {
                var top = $(this).position().top - 124,
                    left = $(this).position().left,
                    content = $(this).text().substring(0, $(this).text().length - 1),
                    id=$(this).attr("id");

                if( localADDinfo[id]==undefined){
                    localADDinfo[id]={
                        top: top,
                        left: left,
                        content:""
                    };
                }else{
                    localADDinfo[id].top=top
                    localADDinfo[id].left=left
                }

            });

            //验证是否选择打印项目
            if(updata.length == 0) {
                //myTips("errortip", 1, "请选择打印项目！", null);
                myAlert("请选择打印项目！",2,null,null);
                return false;
            }


            $("#upData").val(JSON.stringify(updata));

            var telParameter = {
                "org_id":option.org_id,
                "token":option.token,
                "udid":option.udid,
                "voucherContent":JSON.stringify(localADDinfo),
                //凭证内容（json字符串，格式如：（NO1{x：y：val：} ，z1{x：y：val：}））
                "picName": imgId.join(","),
                //图片名称
                "length": $("#paperHeight").val(),
                // 背景长度
                "width": $("#paperWidth").val(),
                // 背景宽度
                "voucherModelId":$("#voucher_model_id").val()
            }

            getData(domain+"/voucher/model/addOrUpdate.htm",telParameter,function (data) {

                if(data.code==200 && data.success==true){
                    myAlert("模板保存成功",1,data.code,null);

                }else {
                    myAlert(data.message,2,data.code,null);
                }
            },"POST",false);

        });


        //打印预览
        $("#preview").click(function(e) {

            //获取本地数据
            //var saveAll=
            var paperHeight = $.trim($("#paperHeight").val());
            var paperWidth = $.trim($("#paperWidth").val());
            var unitPaper = "mm";

            var paperHeight = $.trim($("#paperHeight").val());
            var paperWidth = $.trim($("#paperWidth").val());


            if(paperWidth == "") {
                myAlert("纸张宽度不能为空！",2,null,function(){
                    $("#paperWidth").focus();
                });
                return false;
            }

            if(Number(paperWidth) <= 0) {
                myAlert("纸张宽度只能为正整数！",2,null,function(){
                    $("#paperWidth").focus();
                });
                return false;
            }

            //验证是否设置纸张高度、宽度
            if(paperHeight == "") {
                myAlert("纸张高度不能为空！",2,null,function(){
                    $("#paperHeight").focus();
                });
                return false;
            }
            if(Number(paperHeight) <= 0) {
                myAlert("纸张高度只能为正整数！",2,null,function(){
                    $("#paperHeight").focus();
                });
                return false;
            }


            updata = [];


            $(".print_toolbox ul li[data-save]").each(function() {
                var top = $(this).position().top - 180+10,//基准高度是以180开始计算的
                    left = $(this).position().left+10,    //基准y轴为基准，已按钮的自身便宜量计算的
                    testData = {
                    type_1:{top: 0,left: 0,content:"天津市少年宫智慧教育云平台"},//主标题
                    type_2:{top: 0,left: 0,content:"这里是副标题信息"},//副标题

                    type_3:{top: 0,left: 0,content:"2018年第二学期"},//学期
                    type_4:{top: 0,left: 0,content:"刘某某"},//学员姓名
                    type_5:{top: 0,left: 0,content:"152223201610105932"},//证件号
                    type_6:{top: 0,left: 0,content:"李某某，某某"},//教师姓名
                    type_7:{top: 0,left: 0,content:"舞蹈类"},//科目班级
                    type_8:{top: 0,left: 0,content:"老生班"},//班级类型
                    type_9:{top: 0,left: 0,content:"20"},//课时数
                    type_10:{top: 0,left: 0,content:"2018-12-12"},//开课日期
                    type_11:{top: 0,left: 0,content:"每周五晚17：00-19:00"},//上课时间
                    type_12:{top: 0,left: 0,content:"5600.00"},//学费标准
                    type_13:{top: 0,left: 0,content:"东马路校区"},//校区
                    type_14:{top: 0,left: 0,content:"301"},//教室
                    type_15:{top: 0,left: 0,content:"20"},//班容量
                    type_16:{top: 0,left: 0,content:"微信支付"},//缴费方式
                    type_17:{top: 386,left:50,content:"1200.00"},//缴费金额
                    type_18:{top: 386,left:161,content:"壹仟贰佰圆正"},//缴费金额大写
                    type_19:{top: 0,left: 0,content:"2018-11-11"},//缴费时间
                    type_20:{top: 0,left: 0,content:"2018sng12453"},//凭证编号
                    type_21:{top: 193,left: -734,content:"2018-11-12"},//凭证日期
                    type_22:{top: 0,left: 0,content:"辛某某"},//操作人

                    type_23:{top: 0,left: 0,content:"开始时间：2018-10-10"},//自定义1
                    type_24:{top: 0,left: 0,content:"自定义内容二测试信心"},//自定义2
                    type_25:{top: 0,left: 0,content:"自定义内容三测试信心"},//自定义3
                    type_26:{top: 0,left: 0,content:"自定义内容四测试信心"},//自定义4
                    type_27:{top: 0,left: 0,content:"自定义内容五测试信心"},//自定义5
                    type_28:{top: 0,left: 0,content:"天津市少年儿童艺术培训学校"},//自定义6
                },content = testData[$(this).attr("id")].content;
                    updata.push({
                        top: top,
                        left: left,
                        content: content
                    });

            });

            //验证是否选择打印项目
            if(updata.length == 0) {
                //myTips("errortip", 1, "请选择打印项目！", null);
                myAlert("请选择打印项目！",1,null,null);
                return false;
            }

            LODOP = getLodop();

            printReadyState();

            LODOP.PRINT_INITA(0, 0,paperHeight+"mm", "140mm", "打印预览");
            LODOP.SET_PRINT_PAGESIZE(1, paperWidth + unitPaper, paperHeight + unitPaper, "CreateCustomPage");
            LODOP.SET_PRINT_STYLE("FontSize", 12);
            LODOP.ADD_PRINT_SETUP_BKIMG("<img border='0' src='images/print.jpg'   style='top:-0px'>");
            LODOP.SET_SHOW_MODE("BKIMG_PRINT",1);

           // $("#upData").val(updata);

            var coorInfoArray = updata;

            var unit = "px";
            $.each(coorInfoArray, function(i, item) {

                var top = item.top + unit;
                var left = item.left + unit;
                //LODOP.ADD_PRINT_TEXT(top, left,"216mm","140mm", item.content);
                LODOP.ADD_PRINT_TEXT(top, left,paperHeight+"mm",paperWidth+"mm", item.content);
            });

            LODOP.PREVIEW();
            //LODOP.PRINT();
        });

    });

    //打印前判断打印WebSocket是否准备好
    function printReadyState() {
        if(!LODOP.webskt || LODOP.webskt.readyState != 1) {
            printReadyState();
        }
    }
</script>
