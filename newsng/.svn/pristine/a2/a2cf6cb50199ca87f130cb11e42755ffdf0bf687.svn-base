<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>信息收集</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="../../favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--ui包-->
    <link rel="stylesheet" href="../../../css/sm.css">
    <link rel="stylesheet" href="../../../css/layout.css">
    <style>
        .list-block{margin:0;line-height:1rem;font-size:0.8rem}
        .cont-title{text-indent: 0}
        .cont-box{background-color:#fff;margin-bottom:1rem;padding:0.4rem}
        .cont-box img{width:30%;margin:0.1rem}
        .list-block .item-inner{border-bottom:0}
        .list-block ul{border:0}
        .list-block li li:last-child .item-inner, .list-block li:last-child li .item-inner{border-bottom:0}
        .list-block ul ul{padding-left:0}
        .list-block .item-content{padding-left:0}
        .button.button-fill{display: block;width:80%;margin:1rem auto}
    </style>
</head>

<body>
    <div class="page-group">
        <div class="page page-current" id="mainPage">
            <div class="content native-scroll" id="">
                <div class="list-block">
                    <ul>
                        <li class="cont-box" data-id="" data-type="pic">
                            <p class="cont-title">1.图片收集：请提交开学第一课照片</p>
                            <!--图片上传-->
                            <div class="uploader-cells" id="uploader" style="margin-top: 0">
                                <div class="uploader-cell">
                                    <div class="uploader-cell__bd">
                                        <div class="uploader">
                                            <div class="uploader__bd">
                                                <ul class="uploader__files" id="uploaderFiles">
                                                    <!--<li class="weui-uploader__file" style="background-image:url(../../../images/sng.png)"><div class="delete" data-id="j"><span class="icon icon-remove"></span></div></li>-->
                                                </ul>
                                                <div class="uploader__input-box">
                                                    <!--<input id="uploaderInput" class="uploader__input" type="file" accept="image/*" capture="camera" multiple="" />-->
                                                    <div id="uploaderInput" class="uploader__input"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--图片上传 END-->
                        </li>
                        <li class="cont-box" data-id="" data-type="txt">
                            <p class="cont-title">2.文字收集：请输入开学第一课感想</p>
                            <div class="list-block" style="margin: 0;">
                                <ul>
                                    <li class="align-top">
                                        <div class="item-content">
                                            <div class="item-inner">
                                                <!--通知内容-->
                                                <div class="item-input">
                                                    <!--内容-->
                                                    <textarea placeholder="请输入通知内容" id="noticeText" maxlength="1000" ></textarea>
                                                    <!--内容-->
                                                    <!--通知内容 End-->
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <!-- Switch (Checkbox) -->
                                    <li>
                                        <div class="item-content">
                                            <div class="item-inner">
                                                <div class="item-title"> </div>
                                                <div class="item-after"><span id="noticeLength">0</span>/1000</div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                                <div class="list-block-label" id="tooLtip" style="margin-bottom: .5rem; height:.6rem"><span class="button-danger"></span></div>
                            </div>
                        </li>
                        <li class="cont-box" data-id="" data-type="pic">
                            <p class="cont-title">3.图片收集：请提交开学第二课照片</p>
                            <!--图片上传-->
                            <div class="uploader-cells" id="uploader" style="margin-top: 0">
                                <div class="uploader-cell">
                                    <div class="uploader-cell__bd">
                                        <div class="uploader">
                                            <div class="uploader__bd">
                                                <ul class="uploader__files" id="uploaderFiles">
                                                    <!--<li class="weui-uploader__file" style="background-image:url(../../../images/sng.png)"><div class="delete" data-id="j"><span class="icon icon-remove"></span></div></li>-->
                                                </ul>
                                                <div class="uploader__input-box">
                                                    <!--<input id="uploaderInput" class="uploader__input" type="file" accept="image/*" capture="camera" multiple="" />-->
                                                    <div id="uploaderInput" class="uploader__input"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--图片上传 END-->
                        </li>
                        <li class="cont-box" data-id="" data-type="txt">
                            <p class="cont-title">4.文字收集：请输入开学第一课感想</p>
                            <div class="list-block" style="margin: 0;">
                                <ul>
                                    <li class="align-top">
                                        <div class="item-content">
                                            <div class="item-inner">
                                                <!--通知内容-->
                                                <div class="item-input">
                                                    <!--内容-->
                                                    <textarea placeholder="请输入通知内容" id="noticeText" maxlength="1000" ></textarea>
                                                    <!--内容-->
                                                    <!--通知内容 End-->
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <!-- Switch (Checkbox) -->
                                    <li>
                                        <div class="item-content">
                                            <div class="item-inner">
                                                <div class="item-title"> </div>
                                                <div class="item-after"><span id="noticeLength">0</span>/1000</div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                                <div class="list-block-label" id="tooLtip" style="margin-bottom: .5rem; height:.6rem"><span class="button-danger"></span></div>
                            </div>
                        </li>
                    </ul>
                </div>
                <button id="sub_btn" class="button button-fill">提交</button>
            </div>
        </div>
        
        
    </div>
</body>

</html>
<script src='../../../js/zepto.min.js'></script>
<script src='../../../js/sm.min.js'></script>
<script src='../../../js/config.js'></script>
<script src='https://res.wx.qq.com/open/js/jweixin-1.2.0.js'></script>
<script>
var baseP=getJPermissions(JSON.parse(sessionStorage.baseUser).orguser.org_id);
    wx.config({
        debug: false,
        appId: baseP.appId,
        timestamp: baseP.timestamp,
        nonceStr: baseP.nonceStr,
        signature: baseP.signature,
        jsApiList: [
            'checkJsApi',
            'onMenuShareTimeline',
            'onMenuShareAppMessage',
            'onMenuShareQQ',
            'onMenuShareWeibo',
            'onMenuShareQZone',
            'hideMenuItems',
            'showMenuItems',
            'hideAllNonBaseMenuItem',
            'showAllNonBaseMenuItem',
            'translateVoice',
            'startRecord',
            'stopRecord',
            'onVoiceRecordEnd',
            'playVoice',
            'onVoicePlayEnd',
            'pauseVoice',
            'stopVoice',
            'uploadVoice',
            'downloadVoice',
            'chooseImage',
            'previewImage',
            'uploadImage',
            'downloadImage',
            'getNetworkType',
            'openLocation',
            'getLocation',
            'hideOptionMenu',
            'showOptionMenu',
            'closeWindow',
            'scanQRCode',
            'chooseWXPay',
            'openProductSpecificView',
        ]
    });

</script>
<script>
   //本地存储
    var images = {
        localId: [],
        serverId: []
    };

    var ioslocId=[];//用于兼容ios的本地id列表 图片是base64格式的

    wx.ready(function (){

        //隐藏非基础类菜单
        wx.hideAllNonBaseMenuItem();

        //点击选择图片
        $("#uploaderInput").click(function (){
            wx.chooseImage({
                count: 9-images.localId.length, // 默认9
                sizeType: ['compressed'], // 可以指定是原图还是压缩图，默认二者都有
                sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                success: function (res) {

                    $("#uploaderFiles").append("");

                    //rows="";//声明一个空字符串用于保存循环出来的html
                    images.localId =images.localId.concat(res.localIds); // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
					//去重
                    images.localId=images.localId.unique();

                    if(images.localId.length==9){
                        $("#uploaderInput").parent().hide();
                    }

                    if (window.__wxjs_is_wkwebview) {  //判断ios是不是用的 wkwebview 内核

                        for(var i=0;i<images.localId.length;i++){
                            var todel=images.localId[i];

                            wx.getLocalImgData({  //循环调用  getLocalImgData
                                localId:res.localIds[i], // 图片的localID
                                success: function (res) {

                                    var localData = res.localData; // localData是图片的base64数据，可以用img标签显示
                                    localData = localData.replace('jgp', 'jpeg');//iOS 系统里面得到的数据，类型为 image/jgp,因此需要替换一下

                                   // if($.inArray(localData, ioslocId)>=0){
                                        //images.localId.removeByValue(todel);
                                       // return false
									//}else{
                                        ioslocId.push(localData)  //把base64格式的图片添加到ioslocId数组里 这样该数组里的元素都是base64格式的
                                        rows ='<li class="weui-uploader__file" data-del="'+todel+'" style="background-image:url('+localData+')"><div class="delete" ><span class="icon icon-remove"></span></div></li>';
                                        $("#uploaderFiles").append(rows);
									//}
                                }
                            });
                        }

                    }
                    else{  //如果不是用的wkwebview 内核 或者是用的安卓系统 执行下面的xunh
                        var rows="";
                        $.each(images.localId,function (index,el) {
                            rows  +='<li class="weui-uploader__file"  style="background-image:url('+el+')"><div class="delete" data-id="'+index+'"><span class="icon icon-remove"></span></div></li>';
                        });
                        $("#uploaderFiles").html(rows);
                    }
                }
            });
        })
    });
    $(function(){


        //动态显示文本框字数
        function txtNum(selector) {
            var txtarea = selector.find("textarea");
            var txtnum = txtarea.parents("li").next("li").find("span");
            if(txtarea.length>0){
                txtnum.text(txtarea.val().length);
            }
            
        }
        
        $("[data-type='txt']").each(function(){
            $(this).on("input propertychange",function(){txtNum($(this))});
        })
        
        //提交
        $("#sub_btn").on("click",function(){
            $.confirm("是否确认提交信息？","",function(){
                location.href="msg_cont.html?submit=1";
            },null,"确定","取消")
        })

        // imgHtml +='<figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">'+
        //                     '<a href="'+res.pics[i]+'" itemprop="contentUrl" data-size="1640x1136">' +
        //                     '<img src="'+res.pics[i]+'" onload="getWH(this)" itemprop="thumbnail" width="100%" alt="" style="display: none" />' +
        //                     '<div class="imgLoading"><span class="iconloadingtip"></span></div>' +
        //                     '</a>'+
        //                     '</figure>';

        $("body").on("click","#send_number",function(){
            location.href = "member_list.html";
        })

         //图片预览
         initPhotoSwipeFromDOM('.my-gallery');

         $("#countReader").click(function(){
            window.location="readCount.html?nid="+noticeID;
         });

         //图片报错处理
         $('img').error(function(){
             $(this).next().hide();
             $(this).attr('src',domainName+"/shijiwxy/weixin/images/error.gif");
         });

         //要求回执的通知
         $("#receiptBtn").click(function(){

             var $this=$(this);
             if($this.hasClass("button-light")){
                 return false
             };

             var receiptPorts=domainName+"/eduWeixin/notice/setreceipt";
             var parameter={
                 nu_id:nowNu_id
             };

             getData(receiptPorts,parameter,function(result){
                 if(result.code==200 && result.success==true){
                     $.alert("提交成功！");
                     $this.addClass("button-light").removeClass("button-fill").text("已读");
                     var allNotices=JSON.parse(sessionStorage.tRNotices);
                     var noticeID=GetUrlParam("noticeID");

                     for(var i=allNotices.length-1;i>=0;i--){
                         var res=allNotices[i];
                         if(allNotices[i].nid==noticeID){
                             allNotices[i].noticeUser.receipted=1;
                             break;
                         }
                     }
                     sessionStorage.tRNotices=JSON.stringify(allNotices);
                 }else{
                     $.alert(result.msg);
                 }
             });
         });
	 });

    

    
</script>